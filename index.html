  <!DOCTYPE html>
  <html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meter Installation System</title>

  <style>
  * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
  }

  body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
  }

  .main-content {
      flex: 1;
  }

/* Make container act as positioning reference */
.container {
  position: relative;
}

/* User Manual link inside white card */
.container-help-link {
  position: absolute;
  top: 16px;
  right: 20px;
  z-index: 5;
}

.container-help-link a {
  font-size: 14px;
  font-weight: 600;
  color: #4f46e5;
  text-decoration: underline;
}


  .container {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 1200px;
      margin: 0 auto;
  }

  .login-container {
      max-width: 500px;
      margin: 50px auto;
  }

  .hidden {
      display: none !important;
  }

  h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
      font-size: 28px;
  }

  .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
  }

  .user-info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }

  .user-info .username {
      font-weight: 600;
      font-size: 16px;
  }

  .logout-btn, .reports-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 2px solid white;
      color: white;
      padding: 8px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      margin-left: 10px;
  }

  .logout-btn:hover, .reports-btn:hover {
      background: white;
      color: #667eea;
  }

  .form-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
      transition: all 0.3s ease;
  }

  .form-section.order-section {
      border-left: 4px solid #e74c3c;
      background: #fff5f5;
  }

  .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e0e0e0;
  }

  .form-section.order-section .section-title {
      color: #e74c3c;
  }

  .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
  }

  .form-group {
      margin-bottom: 0;
  }

  label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 500;
      font-size: 14px;
  }

  label .required {
      color: #e74c3c;
      margin-left: 3px;
  }

  input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
      font-family: inherit;
  }

  input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
  }

  select {
      cursor: pointer;
      background-color: white;
  }

  select#orderType {
      border-color: #e74c3c;
      font-weight: 600;
      font-size: 16px;
  }

  select#orderType:focus {
      border-color: #c0392b;
  }

  .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
  }

  button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
  }

  button[type="submit"] {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
  }

  button[type="submit"]:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
  }

  button[type="reset"], button[type="button"] {
      background: #6c757d;
      color: white;
  }

  button[type="reset"]:hover, button[type="button"]:hover {
      background: #5a6268;
  }

  .message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      display: none;
      animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
      from {
          opacity: 0;
          transform: translateY(-10px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

  .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
  }

  .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
  }

.month-year-filter{
  display:flex;
  gap:12px;
  align-items:center;
}


  .info-box {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
  }

  .info-box p {
      margin: 0;
      color: #0c5460;
      font-size: 14px;
  }

  .login-header {
      text-align: center;
      margin-bottom: 30px;
  }

  .login-header h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
  }

  .login-header p {
      color: #666;
      font-size: 14px;
  }

  .login-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 40px;
  }

.app-update {
  margin: 10px auto 20px;
  padding: 10px 14px;
  max-width: 900px;
  text-align: center;

  font-size: 15px;
  font-weight: 800;
  color: #b91c1c;

  background: #fee2e2;
  border: 2px solid #dc2626;
  border-radius: 8px;

  animation: slowBlink 2.5s ease-in-out infinite;
}

@keyframes slowBlink {
  0%   { opacity: 1; }
  50%  { opacity: 0.35; }
  100% { opacity: 1; }
}





  /* ================= REPORT WEB VIEW ================= */
  .print-section {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
  }

  .report-selector {
      margin-bottom: 20px;
  }

  .report-preview {
      background: white;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-top: 20px;
      max-height: 500px;
      overflow: auto; /* Web scrollbar */
  }

  .report-title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #000;
      text-transform: uppercase;
  }

  .report-preview table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: white;
      color: black;
  }

  .report-preview th, .report-preview td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
  }

  .report-preview th {
      background: #f1f5f9 !important;
      font-weight: bold;
      border: 1.5px solid #000;
  }


.dashboard-toast {
  margin: 10px 22px 0;
  padding: 12px 14px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  display: block;
}

.dashboard-toast.hidden {
  display: none;
}



  .report-preview tr.row-red td { color: #dc2626 !important; font-weight: 600; }
  .report-preview tr.row-green td { color: #16a34a !important; font-weight: 600; }

  /* ================= MODAL STYLES ================= */
  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    overflow: hidden;
  }

  body.modal-open { overflow: hidden; }

  .modal-card {
    background: #ffffff;
    width: 100%;
    max-width: 520px;
    max-height: 85vh;
    border-radius: 16px;
    box-shadow: 0 30px 80px rgba(0,0,0,0.35);
    display: flex;
    flex-direction: column;
  }

  .modal-card h2 { padding: 18px 22px 6px; text-align: center; color: #4f46e5; font-size: 20px; }
  .modal-subtitle { text-align: center; font-size: 13px; color: #6b7280; margin-bottom: 12px; }
  .modal-grid { padding: 0 22px 10px; overflow-y: auto; flex: 1; }
  .modal-actions { padding: 16px 22px; display: flex; justify-content: flex-end; gap: 12px; border-top: 1px solid #e5e7eb; background: #f9fafb; }

  .btn { padding: 10px 18px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; }
  .btn.accent { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
  .btn.outline { background: transparent; border: 2px solid #c7d2fe; color: #4f46e5; }


  /* ================= INFO MODAL ================= */
  .app-footer {
    text-align: center;
    font-size: 12px;
    margin-top: 30px;
    color: #fff;
  }

  .footer-links a {
    cursor: pointer;
    color: #e0e7ff;
    margin: 0 4px;
    text-decoration: underline;
  }

  .info-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .info-card {
    background: #fff;
    width: 90%;
    max-width: 800px;
    max-height: 85vh;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
  }

  .info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 18px;
    border-bottom: 1px solid #e5e7eb;
  }

  .info-header h2 {
    font-size: 18px;
    color: #4f46e5;
  }

  .info-header button {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
  }

  .info-content {
    padding: 18px;
    overflow-y: auto;
    font-size: 14px;
    line-height: 1.6;
  }

  .hidden { display: none !important; }


.dashboard-toast.danger {
  background: #fee2e2;
  color: #991b1b;
  border: 2px solid #dc2626;
  font-size: 16px;
  font-weight: 800;
  text-align: center;
}


 .toast {
  position: fixed;
  top: 24px;           /* üëà move to top for better visibility */
  right: 24px;
  min-width: 260px;
  max-width: 420px;
  padding: 14px 18px;
  border-radius: 10px;
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);

  z-index: 999999;     /* üî• ABOVE ALL MODALS */
  pointer-events: none;

  animation: slideIn 0.35s ease;
}

.toast.success { background: linear-gradient(135deg, #16a34a, #22c55e); }
.toast.error   { background: linear-gradient(135deg, #dc2626, #ef4444); }
.toast.info    { background: linear-gradient(135deg, #2563eb, #3b82f6); }

.toast.hidden { display: none; }

@keyframes slideIn {
  from { transform: translateY(20px); opacity: 0; }
  to   { transform: translateY(0); opacity: 1; }
}



  /* =========================================================
    ADVANCED PRINT SYSTEM (FINAL ‚Äì STABLE & CLEAN)
    ========================================================= */

  /* Hide header/footer by default (screen view) */
  #printHeader,
  #printFooter {
    display: none;
  }

  @media print {

  /* ---------------- PAGE SETUP ---------------- */
  @page {
    size: A4 landscape;
    margin: 16mm 10mm 20mm 10mm; /* tighter bottom margin */
  }

  /* ---------------- GLOBAL RESET ---------------- */
  body {
    background: white !important;
    padding: 0 !important;
    margin: 0 !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  * {
    background: white !important;
    box-shadow: none !important;
  }

  /* ---------------- SHOW ONLY REPORTS ---------------- */
  body > .container:not(#reportsContainer) {
    display: none !important;
  }

  #reportsContainer {
    display: block !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* ---------------- REMOVE WEB CONTAINER LOOK ---------------- */
  .print-section,
  .report-preview {
    padding: 0 !important;
    margin: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    background: white !important;
  }

  /* ---------------- HIDE WEB UI ---------------- */
  .button-group,
  .report-selector,
  button,
  .user-info,
  .app-footer {          /* ‚úÖ FOOTER REMOVED FROM PRINT */
    display: none !important;
  }

  /* Hide screen-only page title */
  #reportsContainer > h1 {
    display: none !important;
  }

  #userManualModal iframe {
    background: #fff;
  }

  /* ---------------- PRINT HEADER ---------------- */
  #printHeader {
    display: block !important;
    width: 100%;
    text-align: center;
    border-bottom: 1.5px double #000;
    padding-bottom: 4px;
    margin-bottom: 3px;
    font-size: 11px;
    line-height: 1.25;
  }

  /* ---------------- PRINT FOOTER ---------------- */
  #printFooter {
    display: flex !important;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    justify-content: space-between;
    font-size: 10.5px;
    line-height: 1.25;
    padding: 2px 10mm 0;
    border-top: 1px solid #000;
    background: white;
  }

  /* ‚ùå REMOVE artificial footer padding ‚Äì let table flow naturally */
  #reportPreview {
    padding-bottom: 0 !important;
    margin-bottom: 0 !important;
    max-height: none !important;
    overflow: visible !important;
  }

  /* ---------------- REMOVE DUPLICATE REPORT TITLE ---------------- */
  .report-title {
    display: none !important;
  }

  /* ---------------- TABLE (PLAIN REGISTER STYLE) ---------------- */
  table {
    width: 100% !important;
    border-collapse: collapse !important;
    table-layout: auto;
    margin-top: 2px !important;
    page-break-inside: auto;
  }

  thead {
    display: table-header-group;
  }

  tbody {
    page-break-inside: auto;
  }

  tr {
    page-break-inside: avoid;
  }

  th {
    font-size: 10px !important;
    font-weight: bold;
    padding: 3px 4px !important;
    border: 1px solid #000 !important;
    text-align: center;
    white-space: nowrap !important;
  }

  td {
    font-size: 10px !important;
    padding: 3px 4px !important;
    border: 1px solid #000 !important;
    white-space: nowrap !important;
    word-break: keep-all !important;
    overflow: hidden;
    text-align: center;
    vertical-align: middle;
  }
}


  .reports-btn {
    padding: 10px 16px;
    background: #0f766e;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    margin: 4px;
  }

  .reports-btn:hover {
    background: #115e59;
  }

  

  </style>
  </head>

  <body>

  <!-- Login Form -->
  <div id="loginContainer" class="container login-container">
      
<!-- üìò User Manual (inside white container) -->
<div class="container-help-link">
  <a onclick="openUserManualModal()">
    üìò User Manual
  </a>
</div>



    <div class="login-header">



          <div class="login-icon">üîê</div>
          <h1>Meter Installation System</h1>

          <p>Login or create a new account</p>
      </div>

      <form id="loginForm">

          <div class="form-group">
              <label for="username">Username<span class="required">*</span></label>
              <input
                  type="text"
                  id="username"
                  required
                  placeholder="Enter your username"
                  autocomplete="username"
              >
          </div>

          <div class="form-group" style="margin-top: 20px;">
              <label for="password">Password<span class="required">*</span></label>
              <input
                  type="password"
                  id="password"
                  required
                  placeholder="Enter your password"
                  autocomplete="current-password"
              >
          </div>

          <!-- REGISTRATION DETAILS -->
          <div id="registrationGroup" class="hidden">

              <div class="form-group" style="margin-top: 20px;">
                  <label>Full Name<span class="required">*</span></label>
                  <input id="regName" placeholder="Enter full name">
              </div>

              <div class="form-group">
                  <label>Email<span class="required">*</span></label>
                  <input id="regEmail" type="email" placeholder="Enter email">
              </div>

              <div class="form-group">
                  <label>Mobile<span class="required">*</span></label>
                  <input id="regMobile" placeholder="10-digit mobile number">
              </div>
          </div>

       <!-- üîê OTP VERIFICATION -->
<div id="otpGroup" class="hidden">

  <!-- OTP INPUT -->
  <div class="form-group" style="margin-top:20px;">
    <label>
      OTP <span class="required">*</span>
    </label>
    <input
      id="otp"
      placeholder="Enter OTP"
      autocomplete="one-time-code"
      inputmode="numeric"
    >
  </div>

  <!-- ‚úÖ PAYMENT CONFIRMATION -->
  <div
    style="
      margin-top:12px;
      padding:10px 12px;
      background:#f0fdf4;
      border-left:4px solid #16a34a;
      border-radius:6px;
      font-size:14px;
    "
  >
    <label style="font-weight:600;cursor:pointer;">
      <input
        type="checkbox"
        id="paymentConfirmed"
        style="margin-right:6px"
      >
      I have completed the ‚Çπ749 registration payment
    </label>

    <p style="font-size:12px;color:#065f46;margin-top:6px;">
      ‚ö†Ô∏è OTP will be verified only after payment confirmation.
    </p>
  </div>

</div>


         <!-- ‚ÑπÔ∏è INFO BOX -->
<div class="info-box" style="margin-top:20px">

  <!-- üîí REGISTRATION PAYMENT BLOCK (NEW USERS ONLY) -->
  <div
    id="registrationPaymentBox"
    class="hidden"
    style="
      margin-top:20px;
      padding:16px;
      border-radius:10px;
      background:#f8fafc;
      border:2px dashed #2563eb
    "
  >

    <h3 style="margin-bottom:12px;color:#1e3a8a;font-size:18px">
      üí≥ One-Time Registration Fee
    </h3>

    <p style="font-size:15px;margin-bottom:10px">
      <b>Amount:</b>
      <span style="color:#b91c1c;font-weight:700">‚Çπ749</span>
      <span style="font-size:13px;color:#555">(One Time Only)</span>
    </p>

    <!-- üîπ UPI ID + COPY -->
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:14px">
      <span style="font-size:15px">
        <b>UPI ID:</b>
        <span id="upiIdText" style="font-family:monospace;color:#111827">
          er.ajay96@okicici
        </span>
      </span>

      <button
        type="button"
        onclick="copyUPI()"
        style="
          padding:6px 14px;
          border-radius:6px;
          border:none;
          cursor:pointer;
          font-weight:600;
          background:#2563eb;
          color:#fff;
        "
      >
        üìã Copy UPI
      </button>
    </div>

    <!-- üîπ QR CODE -->
    <div style="text-align:center;padding:10px;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
      <img
        src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=upi://pay?pa=er.ajay96@okicici&pn=Er%20Ajay%20Kumar&am=749&cu=INR"
        alt="UPI QR Code"
        style="padding:6px;border-radius:8px;background:#fff"
      >
      <p style="font-size:12px;color:#555;margin-top:8px">
        Scan using any UPI app<br>
        (GPay / PhonePe / Paytm / BHIM)
      </p>
    </div>

    <!-- üß≠ GUIDE -->
    <div style="margin-top:18px">
      <h4 style="color:#065f46;font-size:15px;margin-bottom:8px">
        üß≠ How to Register
      </h4>

      <ol style="padding-left:18px;font-size:14px;line-height:1.6">
        <li>Pay <b>‚Çπ749</b> via UPI / QR</li>
        <li>Enter Username & Password</li>
        <li>Fill Name, Email & Mobile</li>
        <li>Submit Registration</li>
        <li>Enter OTP after verification</li>
      </ol>

      <p style="font-size:13px;font-weight:600;color:#b91c1c;margin-top:8px">
        ‚ö†Ô∏è OTP is issued only after payment confirmation
      </p>
    </div>

  </div>
</div>

          <button type="submit" id="loginBtn" style="margin-top: 20px; width: 100%;">
              Login / Sign Up
          </button>

          <div id="loginMessage" class="message"></div>

      </form>
  </div>

  <!-- Main Data Entry Form -->
  <div id="mainContainer" class="container hidden">

    <!-- üìò User Manual (inside white container ‚Äì Main Form) -->
<div class="container-help-link">
  <a onclick="openUserManualModal()">
    üìò User Manual
  </a>
</div>


      <div class="user-info">
          <div>
              <span>Logged in as: </span>
              <span class="username" id="currentUser"></span>
          </div>
          <div>
            <button type="button" class="reports-btn" onclick="showReports()">Reports & Print</button>

  <button type="button" class="reports-btn" onclick="openSubmittedDataModal()">
    üëÅ See Submitted Data
  </button>

  <button type="button" class="logout-btn" onclick="logout()">Logout</button>

          </div>
      </div>
   

      <h1>Meter Installation & Connection Form</h1>
      
    <p id="appUpdateBanner" class="app-update hidden"></p>


      
      <p class="subtitle">All fields marked with <span style="color: #e74c3c;">*</span> are required</p>
      
      <div class="info-box">
          <p><strong>Note:</strong> Select order type first. Form fields will appear based on your selection.</p>
      </div>
      
      <form id="meterForm">
          <!-- Order Details Section -->
          <div class="form-section order-section">
              <h2 class="section-title">üìã Order Details</h2>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="orderType">Order Type<span class="required">*</span></label>
                      <select id="orderType" name="orderType" required>
                          <option value="">-- Select Order Type First --</option>
                          <option value="MCO">MCO (Meter Change Order)</option>
                          <option value="SCO">SCO (Service Connection Order)</option>
                          <option value="PDCO">PDCO (Permanent Disconnection Order)</option>
                          <option value="SJO_Name_Change">SJO - Name Change</option>
                          <option value="SJO_Load_extension">SJO - Load Extension</option>
                          <option value="SJO_Cate_Change">SJO - Category Change</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="orderNo">Order No.<span class="required">*</span></label>
                      <input type="text" id="orderNo" name="orderNo" required placeholder="e.g., MCO/100001930063/20250708">
                  </div>
                  
                  <div class="form-group">
                      <label for="effectDate">Effect Date<span class="required">*</span></label>
                      <input type="date" id="effectDate" name="effectDate" required>
                  </div>
              </div>
          </div>
          
          <!-- Basic Information Section -->
          <div class="form-section" id="basicInfoSection">
              <h2 class="section-title">üë§ Basic Information</h2>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="name">Consumer Name<span class="required">*</span></label>
                      <input type="text" id="name" name="name" required placeholder="Enter full name">
                  </div>
                  
                  <div class="form-group">
                      <label for="consumerID">Consumer ID<span class="required">*</span></label>
                      <input type="text" id="consumerID" name="consumerID" required placeholder="e.g., 200007032516">
                  </div>
                    <div class="form-group">
                      <label for="connectedLoad">Connected Load (KW)<span class="required">*</span></label>
                      <input type="number" step="0.01" id="connectedLoad" name="connectedLoad" placeholder="e.g., 5.00">
                  </div>
                  <div class="form-group">
                      <label for="category">Category<span class="required">*</span></label>
                      <select id="category" name="category" required>
                          <option value="">Select Category</option>
                          <option value="Domestic">Domestic</option>
                          <option value="Commercial">Commercial</option>
                          <option value="Industrial">Industrial</option>
                          <option value="Temp">Temp</option>
                          <option value="Agri">Agri</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="mru">MRU<span class="required">*</span></label>
                      <input type="text" id="mru" name="mru" required placeholder="e.g., BD, KTD, RJD">
                  </div>
              </div>
          </div>
          
          <!-- New Meter Details Section -->
          <div class="form-section hidden" id="newMeterSection">
              <h2 class="section-title">‚ö° New Meter Details</h2>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="meterNo">Meter No.<span class="required">*</span></label>
                      <input type="text" id="meterNo" name="meterNo" placeholder="Enter meter number">
                  </div>
                  
                  <div class="form-group">
                      <label for="make">Make<span class="required">*</span></label>
                      <select id="make" name="make">
                          <option value="">Select Make</option>
                          <option value="LnT">LnT</option>
                          <option value="HE">HE</option>
                          <option value="Visiontek">Visiontek</option>
                          <option value="Eppletone">Eppletone</option>
                          <option value="HPL">HPL</option>
                          <option value="Flash">Flash</option>
                          <option value="AEW">AEW</option>
                          <option value="Montel">Montel</option>
                          <option value="Genus">Genus</option>
                          <option value="SECURE METER PVT LTD">SECURE METER PVT LTD</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="amp">Amp<span class="required">*</span></label>
                      <select id="amp" name="amp">
                          <option value="">Select Amp</option>
                          <option value="5-20A">5-20A</option>
                          <option value="5-30A">5-30A</option>
                          <option value="10-40A">10-40A</option>
                          <option value="10-60A">10-60A</option>
                          <option value="200/5,100/5">200/5,100/5</option>
                          <option value="(3-Œ¶) 10-60A">(3-Œ¶) 10-60A</option>
                      </select>
                  </div>
                  
                
                  
                  <div class="form-group">
                      <label for="newReading">New Reading</label>
                      <input type="text" id="newReading" name="newReading" placeholder="Enter new meter reading">
                  </div>
                  
                  <div class="form-group" id="serviceLengthGroup">
                      <label for="serviceLength">Service Length</label>
                      <input type="text" id="serviceLength" name="serviceLength" placeholder="e.g., 0.8/0.7/0.1 or 40">
                  </div>
              </div>
          </div>
          
          <!-- Old Meter Details Section -->
          <div class="form-section hidden" id="oldMeterSection">
              <h2 class="section-title">üîß Old Meter Details</h2>
              <div class="form-grid">
                  <div class="form-group">
                      <label for="oldMeterDetail">Old Meter Detail</label>
                      <input type="text" id="oldMeterDetail" name="oldMeterDetail" placeholder="Enter old meter number">
                  </div>
                  
                  <div class="form-group">
                      <label for="oldMeterMake">Old Meter Make</label>
                      <select id="oldMeterMake" name="oldMeterMake">
                          <option value="">Select Make</option>
                          <option value="LnT">LnT</option>
                          <option value="HE">HE</option>
                          <option value="Visiontek">Visiontek</option>
                          <option value="Eppletone">Eppletone</option>
                          <option value="HPL">HPL</option>
                          <option value="Flash">Flash</option>
                          <option value="AEW">AEW</option>
                          <option value="Montel">Montel</option>
                          <option value="Genus">Genus</option>
                          <option value="SECURE METER PVT LTD">SECURE METER PVT LTD</option>
                          <option value="NV">NV (Not Visible)</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="oldMeterAmp">Old Meter Amp</label>
                      <select id="oldMeterAmp" name="oldMeterAmp">
                          <option value="">Select Amp</option>
                          <option value="5-20A">5-20A</option>
                          <option value="5-30A">5-30A</option>
                          <option value="10-40A">10-40A</option>
                          <option value="10-60A">10-60A</option>
                          <option value="200/5">200/5</option>
                          <option value="(3-Œ¶) 10-60A">(3-Œ¶) 10-60A</option>
                      </select>
                  </div>
                  
                  <div class="form-group">
                      <label for="oldMeterReading">Old Meter Reading</label>
                      <input type="text" id="oldMeterReading" name="oldMeterReading" placeholder="Enter old meter reading">
                  </div>
              </div>
          </div>
          
          <div class="button-group">
              <button type="reset">Clear Form</button>
              <button type="submit" id="submitBtn">Submit Data</button>
          </div>
          
          <div id="responseMessage" class="message"></div>
      </form>
  </div>

  <!-- ================= REPORTS SECTION ================= -->
  <div id="reportsContainer" class="container hidden">

    <!-- Web-only header (hidden in print) -->
    <div class="user-info">
      <div>
        <span>Reports & Printing</span>
      </div>
      <div>
        <button type="button" class="reports-btn" onclick="showMain()">Back to Form</button>
        <button type="button" class="logout-btn" onclick="logout()">Logout</button>
      <button
    type="button"
    class="reports-btn"
    onclick="openOfficeProfileModal()">
    üè¢ Add / Edit Current Office Data
  </button>


      </div>
    </div>

<h1 style="display:flex;justify-content:space-between;align-items:center">
  <span>Reports & Print Preview</span>

  <a
    style="font-size:14px;color:#2563eb;cursor:pointer;font-weight:600"
    onclick="openInfoModal('reports_help')">
    ‚ùì Help
  </a>
</h1>


    <div class="print-section">

      <!-- ================= PRINT HEADER ================= -->
    <div id="printHeader">
    <div style="font-size:13px;font-weight:bold">
      HIMACHAL PRADESH STATE ELECTRICITY BOARD LTD.
    </div>

    <div style="font-size:11px;font-weight:bold">
      Electrical Section <span id="officeSectionPrint">______________</span>
    </div>

    <div id="printReportTitle"
        style="font-size:12px;font-weight:bold;margin:4px 0;text-decoration:underline">
    </div>

    <div style="display:flex;justify-content:space-between;
                font-size:10.5px;border-top:1px solid #000;padding-top:3px">
      <span>
        <strong>Station:</strong>
        <span id="officeStationPrint">______________</span>
      </span>

      <span>
        <strong>Generated By:</strong>
        <span id="printUsername"></span>
      </span>

      <span>
        <strong>Date/Time:</strong>
        <span id="printDate"></span>
      </span>
    </div>
  </div>


    <!-- ================= END PRINT HEADER ================= -->

<!-- Web-only controls -->
<div class="report-selector"
     style="display:flex;flex-wrap:wrap;align-items:center;gap:14px">

  <!-- Report Type -->
  <label for="reportType">Select Report Type:</label>
  <select id="reportType" onchange="loadReport()">
    <option value="">-- Select Report --</option>
    <option value="CA_21">CA-21 (New Meter Installation)</option>
    <option value="CA_22">CA-22 (Old Meter Removal)</option>
    <option value="CA_25">CA-25 (Material Data)</option>
    <option value="CS_29">CS-29 (Sealing Register)</option>
    <option value="MONTHLY_REGISTER">
      üìÖ Month-wise / Date-wise Consolidated Register
    </option>
  </select>

  <!-- FILTER MODE (RADIO BUTTONS) -->
  <div id="filterModeSelector"
       class="month-year-filter hidden"
       style="display:flex;align-items:center;gap:16px;font-weight:600">

    <label>
      <input type="radio"
             name="filterMode"
             value="MONTH_YEAR"
             checked
             onchange="switchFilterMode()">
      Month / Year
    </label>

    <label>
      <input type="radio"
             name="filterMode"
             value="DATE_RANGE"
             onchange="switchFilterMode()">
      Date Range
    </label>
  </div>

  <!-- MONTH / YEAR MODE -->
  <div id="monthYearFilter"
       class="month-year-filter hidden"
       style="display:flex;gap:10px;align-items:center">

    <label>Month:</label>
    <select id="reportMonth" onchange="loadReport()">
      <option value="0">Jan</option>
      <option value="1">Feb</option>
      <option value="2">Mar</option>
      <option value="3">Apr</option>
      <option value="4">May</option>
      <option value="5">Jun</option>
      <option value="6">Jul</option>
      <option value="7">Aug</option>
      <option value="8">Sep</option>
      <option value="9">Oct</option>
      <option value="10">Nov</option>
      <option value="11">Dec</option>
    </select>

    <label>Year:</label>
    <input type="number"
           id="reportYear"
           style="width:90px"
           onchange="loadReport()">
  </div>

  <!-- DATE RANGE MODE -->
  <div id="dateRangeFilter"
       class="month-year-filter hidden"
       style="display:flex;gap:10px;align-items:center">

    <label>From:</label>
    <input type="date" id="fromDate" onchange="loadReport()">

    <label>To:</label>
    <input type="date" id="toDate" onchange="loadReport()">

    <button type="button"
            onclick="resetDateFilters()"
            style="padding:6px 10px;font-size:13px">
      Reset
    </button>
  </div>

  <!-- Order Type Filter -->
  <label for="orderTypeFilter">Order Type:</label>
  <select id="orderTypeFilter"
          onchange="applyOrderTypeFilter()"
          disabled>
    <option value="">All</option>
    <option value="SCO">SCO</option>
    <option value="MCO">MCO</option>
    <option value="PDCO">PDCO</option>
    <option value="SJO_Name_Change">SJO ‚Äì Name Change</option>
    <option value="SJO_Load_extension">SJO ‚Äì Load Extension</option>
    <option value="SJO_Cate_Change">SJO ‚Äì Category Change</option>
  </select>

</div>


      <div class="button-group">
        <button
    type="button"
    class="reports-btn"
    onclick="openReportsDashboard()">
    ‚òÅÔ∏è Reports Dashboard
  </button>

        <button type="button" onclick="exportToExcel()">üìä Export to Excel</button>
        <button type="button" onclick="printReport()">üñ®Ô∏è Print Report</button>
    
  </div>

      <!-- ================= REPORT TABLE ================= -->
  <h3 style="margin-top:20px;color:#374151">
    üìÑ Report Preview
  </h3>

  <div id="reportPreview" class="report-preview" style="margin-top:10px">

        <p style="text-align:center;color:#666">
          Select a report type to preview
        </p>
      </div>
      <!-- ================= END REPORT TABLE ================= -->


      <!-- ================= PRINT FOOTER ================= -->
    <div id="printFooter">
    <div style="text-align:left;width:33%">
      Entry Verified By:<br><br>
      ___________________<br>
      (Computer Operator)
    </div>

    <div style="text-align:center;width:33%">
      <br>Official Seal
    </div>

    <div style="text-align:right;width:33%">
      Authorized Signatory:<br><br>
      Er. <span id="officeOfficerPrint">____________</span><br>
      <span id="officeDesignationPrint">Junior Engineer</span>,
      <span id="officeSectionFooterPrint">____________</span>
    </div>
  </div>


      <!-- ================= END PRINT FOOTER ================= -->


    

    </div>



  </div>
  <!-- ================= END REPORTS SECTION ================= -->

  <!-- ================= OFFICE PROFILE MODAL ================= -->
  <div id="officeProfileModal" class="modal hidden">
    <div class="modal-card" style="max-width:700px">

      <h2>üè¢ Office Profile</h2>
      <p class="modal-subtitle">
        These details will appear on printed reports
      </p>

      <div class="modal-grid">
        <div class="form-group">
          <label>Electrical Section</label>
          <input id="officeSection" placeholder="e.g. Ghatta">
        </div>

        <div class="form-group">
          <label>Station / Sub Division</label>
          <input id="officeStation" placeholder="e.g. ESD Baggi">
        </div>

        <div class="form-group">
          <label>Authorized Officer Name</label>
          <input id="officeOfficer" placeholder="e.g. Er Ajay Kumar">
        </div>

        <div class="form-group">
          <label>Designation</label>
          <input id="officeDesignation" value="Junior Engineer">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn outline" onclick="closeOfficeProfileModal()">
          Cancel
        </button>
        <button class="btn accent" onclick="saveOfficeProfile()">
          üíæ Save / Update
        </button>
      </div>

    </div>
  </div>
  <!-- ================= END OFFICE PROFILE MODAL ================= -->

  <!-- ================= CA-25 REPORTS MODAL ================= -->
  <div id="ca25ReportsModal" class="modal hidden">
    <div class="modal-card" style="max-width:700px">

      <h2>üìÇ Available CA-25 Reports</h2>
      <p class="modal-subtitle">
        Generated CA-25 PDFs stored in your cloud folder
      </p>

      <div class="modal-grid" style="max-height:55vh;overflow:auto">
        <ul id="ca25ReportList" style="list-style:none;padding-left:0"></ul>
      </div>

      <div class="modal-actions">
        <button class="btn outline" onclick="closeCA25ReportsModal()">
          Close
        </button>
      </div>

    </div>
  </div>
  <!-- ================= END CA-25 REPORTS MODAL ================= -->


  <!-- üîπ CA-25 DYNAMIC INPUT MODAL -->
  <div id="ca25Modal" class="modal hidden">
    <div class="modal-card">
      <h2>üìÑ CA-25 Details</h2>
      <p class="modal-subtitle">Review & edit details before PDF generation</p>
    <div class="form-group" style="display:flex; gap:8px; align-items:flex-end">
  <div style="flex:1">
    <label>Reuse Previous Entry</label>
    <select
      id="ca25HistorySelect"
      onchange="applyCA25History(this.value)">
      <option value="">‚Äî Select saved work ‚Äî</option>
    </select>
  </div>

  <button
    type="button"
    class="btn outline"
    style="height:42px"
    onclick="deleteSelectedCA25Entry()"
    title="Delete selected entry">
    üóë
  </button>
</div>


      <div class="modal-grid">
        <div class="form-group">
          <label>Name of Works</label>
          <input id="ca25WorkName" placeholder="e.g. New Service Connection Works">
        </div>

        <div class="form-group">
          <label>Measurement taken by</label>
          <input id="ca25MeasurementBy" placeholder="Ajay Kumar, JE">
        </div>

        <div class="form-group">
          <label>Officer Name</label>
          <input id="ca25OfficerName" placeholder="Er Ajay Kumar">
        </div>

        <div class="form-group">
          <label>Designation / Office</label>
          <input id="ca25OfficerDesignation" placeholder="JE Ghatta">
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn outline" onclick="closeCA25Modal()">Cancel</button>
      <button
    id="submitCA25Btn"
    class="btn accent"
    onclick="submitCA25Modal()">
    Generate PDF
  </button>

      </div>
    </div>
  </div>

  <div id="cs24ReportsModal" class="modal hidden">
    <div class="modal-card">
      <h2>üìÇ Available CS-24 Reports</h2>
      <p class="modal-subtitle">MRU-wise CS-24 registers</p>

      <div class="modal-grid">
        <ul id="cs24ReportList" style="list-style:none;padding-left:0"></ul>
      </div>

      <div class="modal-actions">
        <button class="btn outline" onclick="closeCS24Modal()">Close</button>
      </div>
    </div>
  </div>

  <div id="submittedDataModal" class="modal hidden">
    <div class="modal-card" style="max-width:95%;height:90vh">

      <h2>üìã Submitted Data Review</h2>
      <p class="modal-subtitle">Edit / Delete your submitted records</p>

      <div class="modal-grid" style="overflow:auto">

    <!-- üîç FILTER BAR -->
    <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
      
      <input
        type="text"
        id="submittedSearch"
        placeholder="Search Consumer ID / Name / Meter No"
        oninput="applySubmittedFilter()"
        style="padding:6px 10px;width:260px"
      >

      <select id="submittedOrderType" onchange="applySubmittedFilter()">
        <option value="">All Order Types</option>
        <option value="SCO">SCO</option>
        <option value="MCO">MCO</option>
        <option value="PDCO">PDCO</option>
        <option value="SJO_Name_Change">SJO ‚Äì Name Change</option>
        <option value="SJO_Load_extension">SJO ‚Äì Load Extension</option>
        <option value="SJO_Cate_Change">SJO ‚Äì Category Change</option>
      </select>

    </div>

    <!-- üìã TABLE -->
    <table id="submittedDataTable" class="report-preview"></table>
  </div>


      <div class="modal-actions">
        <button class="btn outline" onclick="closeSubmittedDataModal()">Cancel</button>
        <button class="btn accent" onclick="saveSubmittedData()">üíæ Save Changes</button>
      </div>

    </div>
  </div>

  <!-- ================= REPORTS DASHBOARD MODAL ================= -->
  <!-- ================= REPORTS DASHBOARD MODAL ================= -->
  <div id="reportsDashboardModal" class="modal hidden">
    <div class="modal-card" style="max-width:900px">





      <h2>‚òÅÔ∏è Reports Dashboard</h2>
      <p class="modal-subtitle">
        Generate & manage all register PDFs (cloud stored)
      </p>


<!-- Dashboard Toast -->
<div id="dashboardToast" class="dashboard-toast hidden"></div>

      <div class="modal-grid"
          style="display:grid;
                  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
                  gap:16px">

        <!-- CS-24 -->
        <div class="form-section">
          <h3 class="section-title">üóÇÔ∏è CS-24 Register</h3>
    <button
  class="reports-btn"
  onclick="generateAllCS24MRUPDF(this)">
  Generate CS-24 (All MRUs ‚Äì Single PDF)
</button>


          <button class="reports-btn" onclick="openCS24FromDashboard()">
            View Available CS-24 Reports
          </button>
        </div>

        <!-- CA-25 -->
        <div class="form-section">
          <h3 class="section-title">üìÑ CA-25 Register</h3>
          <button class="reports-btn" onclick="openCA25GenerateFromDashboard()">
            Generate CA-25 PDF
          </button>
          <button class="reports-btn" onclick="openCA25ReportsFromDashboard()">
            View Available CA-25 Reports
          </button>
        </div>

        <!-- CA-21 -->
<div class="form-section">
  <h3 class="section-title">üìò CA-21 Register</h3>

  <button
    class="reports-btn"
    onclick="generateRegisterPDFWithStatus(this, 'CA-21', 'CA_21')">
    Generate CA-21 PDF
  </button>

  <button class="reports-btn" onclick="openRegisterReports('CA_21')">
    View Available CA-21 Reports
  </button>
</div>

<!-- CA-22 -->
<div class="form-section">
  <h3 class="section-title">üìô CA-22 Register</h3>

  <button
    class="reports-btn"
    onclick="generateRegisterPDFWithStatus(this, 'CA-22', 'CA_22')">
    Generate CA-22 PDF
  </button>

  <button class="reports-btn" onclick="openRegisterReports('CA_22')">
    View Available CA-22 Reports
  </button>
</div>

<!-- CS-29 -->
<div class="form-section">
  <h3 class="section-title">üìó CS-29 Register</h3>

  <button
    class="reports-btn"
    onclick="generateRegisterPDFWithStatus(this, 'CS-29', 'CS_29')">
    Generate CS-29 PDF
  </button>

  <button class="reports-btn" onclick="openRegisterReports('CS_29')">
    View Available CS-29 Reports
  </button>
</div>

      </div>

      <div class="modal-actions">
        <button class="btn outline" onclick="closeReportsDashboard()">Close</button>
      </div>

    </div>
  </div>

  <!-- ================= END DASHBOARD MODAL ================= -->
  <!-- ================= GENERIC REGISTER REPORTS MODAL ================= -->
  <div id="genericRegisterModal" class="modal hidden">
    <div class="modal-card" style="max-width:720px">

      <h2 id="genericRegisterTitle">üìÇ Available Reports</h2>
      <p class="modal-subtitle" id="genericRegisterSubtitle"></p>

      <div class="modal-grid" style="max-height:55vh;overflow:auto">
        <ul id="genericRegisterList" style="list-style:none;padding-left:0"></ul>
      </div>

      <div class="modal-actions">
        <button class="btn outline" onclick="closeGenericRegisterModal()">
          Close
        </button>
      </div>

    </div>
  </div>
  <!-- ================= END GENERIC REGISTER REPORTS MODAL ================= -->


<!-- Toast Notification -->
<div id="toast" class="toast hidden"></div>


<!-- üìò USER MANUAL MODAL -->
<div id="userManualModal" class="modal hidden">
  <div class="modal-card" style="max-width:90%; height:90vh;">

    <h2 style="padding:16px 22px; color:#4f46e5;">
      üìò User Manual
    </h2>

    <div style="flex:1; padding:0 16px 16px;">
      <iframe
        src="https://drive.google.com/file/d/1apHNO08GkWVm0D3TxHawza0nf338bAkh/preview"
        style="
          width:100%;
          height:100%;
          border:none;
          border-radius:10px;
        ">
      </iframe>
    </div>

    <div class="modal-actions">
      <button class="btn outline" onclick="closeUserManualModal()">
        Close
      </button>
    </div>

  </div>
</div>


  <script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ2O5YmiNvRUvgfn-41rFrRzd8-Dgk1SpK0X4a3eJUp_gvvAMopBnACBigq9Sel2M/exec';
  let currentUsername = null;
  let deviceId = null;
  let originalReportData = [];
  let submittedDataCache = [];

  /* ---------- DEVICE ID GENERATION ---------- */
  function generateDeviceId() {
      const stored = localStorage.getItem('deviceId');
      if (stored) return stored;
      
      const id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('deviceId', id);
      return id;
  }

  /* ---------- ELEMENTS ---------- */
  const loginForm = document.getElementById('loginForm');
  const meterForm = document.getElementById('meterForm');
  const loginMessage = document.getElementById('loginMessage');
  const responseMessage = document.getElementById('responseMessage');
  const loginBtn = document.getElementById('loginBtn');

  /* ---------- LOGIN ---------- */
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginBtn.disabled = true;
  showLogin('', '');

  deviceId = generateDeviceId();

  const payload = {
    username: username.value.trim().toLowerCase(),
    password: password.value,
    deviceId: deviceId
  };

  /* ---------- OTP VERIFICATION ---------- */
  if (!otpGroup.classList.contains('hidden')) {
    payload.action = 'verifyOtp';
    payload.otp = otp.value.trim();

    // ‚úÖ NEW: payment confirmation flag
    payload.paymentConfirmed =
      document.getElementById('paymentConfirmed')?.checked ? 'true' : 'false';
  }

  /* ---------- NEW USER REGISTRATION ---------- */
  else if (!registrationGroup.classList.contains('hidden')) {
    payload.action = 'registerUser';
    payload.name = regName.value.trim();
    payload.email = regEmail.value.trim();
    payload.mobile = regMobile.value.trim();
  }

  /* ---------- NORMAL LOGIN ---------- */
  else {
    payload.action = 'login';
  }

  try {
    const body = new URLSearchParams(payload);
    const res = await fetch(SCRIPT_URL, { method: 'POST', body });
    const data = JSON.parse(await res.text());

    /* ---------- LOGIN SUCCESS ---------- */
    if (data.status === 'success') {
      currentUsername = data.username;
      localStorage.setItem('username', currentUsername);
      loginContainer.classList.add('hidden');
      mainContainer.classList.remove('hidden');
      currentUser.textContent = currentUsername;
    }

    /* ---------- NEW USER DETECTED ---------- */
    else if (data.status === 'new_user' || data.status === 'details_required') {
      registrationGroup.classList.remove('hidden');
      registrationPaymentBox.classList.remove('hidden'); // ‚úÖ SHOW PAYMENT BLOCK
      otpGroup.classList.add('hidden');
      showLogin(data.message, 'success');
    }

    /* ---------- OTP SENT ---------- */
    else if (data.status === 'otp_sent') {
      otpGroup.classList.remove('hidden');
      registrationGroup.classList.add('hidden');
      registrationPaymentBox.classList.remove('hidden'); // keep payment visible
      showLogin(data.message, 'success');
    }

    /* ---------- ERROR ---------- */
    else {
      showLogin(data.message || 'Login failed', 'error');
    }

  } catch (err) {
    console.error(err);
    showLogin('Server / Network error', 'error');
  }

  loginBtn.disabled = false;
});

  /* ---------- ORDER TYPE VISIBILITY ---------- */
  orderType.addEventListener('change', () => {
    const orderTypeValue = orderType.value;
    
    // New meter section visibility
    newMeterSection.classList.toggle(
      'hidden', !['SCO', 'MCO'].includes(orderTypeValue)
    );
    
    // Old meter section visibility
    oldMeterSection.classList.toggle(
      'hidden', !['MCO', 'PDCO'].includes(orderTypeValue)
    );
    
    // Service length visibility - ONLY for SCO
    serviceLengthGroup.classList.toggle(
      'hidden', orderTypeValue !== 'SCO'
    );
  });

  /* ---------- SUBMIT METER DATA ---------- */
  meterForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    showForm('', '');

    if (!currentUsername) {
      showForm('Session expired. Please login again.', 'error');
      logout();
      return;
    }

    try {
      const formData = new FormData(meterForm);
      formData.append('action', 'submitData');
      formData.append('username', currentUsername);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      });

      const data = JSON.parse(await res.text());

      if (data.status === 'success') {
        showForm(
          `Saved successfully. Consumer ID: ${data.consumerID}`,
          'success'
        );
        meterForm.reset();
        newMeterSection.classList.add('hidden');
        oldMeterSection.classList.add('hidden');
        serviceLengthGroup.classList.add('hidden');
      } else {
        showForm(data.message || 'Submission failed', 'error');
      }

    } catch (err) {
      console.error(err);
      showForm('Submission error', 'error');
    }
  });

  /* ---------- REPORTS ---------- */
  function showReports() {
    mainContainer.classList.add('hidden');
    reportsContainer.classList.remove('hidden');
    loadUserMRUs();

    // üîë LOAD OFFICE PROFILE FOR PRINT
    loadOfficeProfileForPrint();
  }

  async function loadOfficeProfileForPrint() {
    const fd = new FormData();
    fd.append('action', 'getOfficeProfile');
    fd.append('username', currentUsername);

    try {
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
      const data = JSON.parse(await res.text());

      if (data.status === 'success' && data.profile) {
        applyOfficeProfileToPrint(data.profile);
      } else {
        // Keep placeholders if no profile exists
        applyOfficeProfileToPrint({});
      }

    } catch (err) {
      console.error('Office profile load failed', err);
    }
  }

  /* ---------- REPORT TYPE CHANGE HANDLER ---------- */

  function showMain() {
    reportsContainer.classList.add('hidden');
    mainContainer.classList.remove('hidden');
  }




  async function loadUserMRUs() {
    try {
      const formData = new FormData();
      formData.append('action', 'fetchUserMRUs');
      formData.append('username', currentUsername);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      });

      const result = JSON.parse(await res.text());

      if (result.status === 'success' && result.mruList) {
        updateMRUDropdown(result.mruList);
      }
    } catch (err) {
      console.error('Error loading MRUs:', err);
    }
  }

  function updateMRUDropdown(mruList) {
    const reportTypeSelect = document.getElementById('reportType');
    
    // Remove existing MRU options
    const options = reportTypeSelect.querySelectorAll('option');
    options.forEach(option => {
      if (option.value.length <= 3 && option.value !== '') {
        option.remove();
      }
    });
    
    // Add user's MRUs
    if (mruList && mruList.length > 0) {
      mruList.forEach(mru => {
        const option = document.createElement('option');
        option.value = mru;
        option.textContent = `MRU: ${mru}`;
        reportTypeSelect.appendChild(option);
      });
    }
  }
async function loadReport() {
  const reportType   = document.getElementById('reportType')?.value || '';
  const preview      = document.getElementById('reportPreview');
  const orderFilter  = document.getElementById('orderTypeFilter');
  const monthFilter  = document.getElementById('monthYearFilter');
  const dateFilter   = document.getElementById('dateRangeFilter');
  const modeBox      = document.getElementById('filterModeSelector');

  /* 1Ô∏è‚É£ No report selected */
  if (!reportType) {
    preview.innerHTML =
      '<p style="text-align:center;color:#666">Select a report type to preview</p>';

    originalReportData = [];
    orderFilter && (orderFilter.disabled = true);

    monthFilter?.classList.add('hidden');
    dateFilter?.classList.add('hidden');
    modeBox?.classList.add('hidden');
    return;
  }

  /* 2Ô∏è‚É£ Monthly Register UI */
  const isMonthly = reportType === 'MONTHLY_REGISTER';

  if (isMonthly) {
    modeBox?.classList.remove('hidden');
  } else {
    modeBox?.classList.add('hidden');
    monthFilter?.classList.add('hidden');
    dateFilter?.classList.add('hidden');
  }

  /* 3Ô∏è‚É£ Read filter mode */
  const filterMode =
    document.querySelector('input[name="filterMode"]:checked')?.value || 'MONTH_YEAR';

  const usingDateRange = filterMode === 'DATE_RANGE';

  /* 4Ô∏è‚É£ Read inputs */
  const month    = Number(document.getElementById('reportMonth')?.value);
  const year     = Number(document.getElementById('reportYear')?.value);
  const fromDate = document.getElementById('fromDate')?.value;
  const toDate   = document.getElementById('toDate')?.value;

  /* 5Ô∏è‚É£ Validation */
  if (isMonthly) {
    if (usingDateRange) {
      if (!fromDate || !toDate) return;
      if (new Date(fromDate) > new Date(toDate)) {
        preview.innerHTML =
          '<p style="text-align:center;color:#e67e22">From date cannot be after To date</p>';
        return;
      }
    } else {
      if (isNaN(month) || isNaN(year) || year < 2000) return;
    }
  }

  /* 6Ô∏è‚É£ Prepare request */
  try {
    const formData = new FormData();
    formData.append('action', 'fetchReportData');
    formData.append('username', currentUsername);
    formData.append('reportType', reportType);

    if (isMonthly) {
      formData.append('filterMode', filterMode);

      if (usingDateRange) {
        formData.append('fromDate', fromDate);
        formData.append('toDate', toDate);
      } else {
        formData.append('month', month);
        formData.append('year', year);
      }

      orderFilter && (orderFilter.disabled = true);
    }

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      originalReportData = result.data || [];
      displayReport(originalReportData, reportType);
    } else {
      preview.innerHTML =
        '<p style="text-align:center;color:#e74c3c">No data available</p>';
    }

  } catch (err) {
    console.error(err);
    preview.innerHTML =
      '<p style="text-align:center;color:#e74c3c">Error loading report</p>';
  }
}


  function applyOrderTypeFilter() {
    const filter = document.getElementById('orderTypeFilter').value;

    if (!filter || originalReportData.length === 0) {
      displayReport(originalReportData, document.getElementById('reportType').value);
      return;
    }

    const headers = originalReportData[0];

    // Try to locate Order Type column
    const orderTypeIndex = headers.findIndex(h =>
      h.toLowerCase().includes('order type')
    );

    // If Order Type column NOT present ‚Üí do nothing safely
    if (orderTypeIndex === -1) {
      console.warn('Order Type column not found for this report');
      displayReport(originalReportData, document.getElementById('reportType').value);
      return;
    }

    const filteredRows = originalReportData
      .slice(1)
      .filter(row => row[orderTypeIndex] === filter);

    displayReport([headers, ...filteredRows],
      document.getElementById('reportType').value
    );
  }



  function displayReport(data, reportType) {
    if (!data || data.length === 0) {
      document.getElementById('reportPreview').innerHTML = '<p style="text-align: center; color: #666;">No data found</p>';
      return;
    }

    // Get report title
    let reportTitle = getReportTitle(reportType);
    
    let html = `<h2 class="report-title">${reportTitle}</h2>`;
    html += '<table><thead><tr>';
    
    // Add headers (excluding COLOR column)
    data[0].forEach((header, index) => {
      if (header !== 'COLOR') {
        html += `<th>${header}</th>`;
      }
    });
    html += '</tr></thead><tbody>';

    // Find COLOR column index
    const colorIndex = data[0].indexOf('COLOR');
    
    // Add data rows with color coding
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      let rowClass = '';
      
      // Check COLOR column if exists
      if (colorIndex !== -1 && row[colorIndex]) {
        const colorValue = row[colorIndex];
        if (colorValue === 'RED') {
          rowClass = 'row-red';
        } else if (colorValue === 'GREEN') {
          rowClass = 'row-green';
        } else if (colorValue === 'BLACK') {
          rowClass = 'row-black';
        }
      }
      
      html += `<tr class="${rowClass}">`;
      row.forEach((cell, index) => {
        // Skip COLOR column
        if (data[0][index] !== 'COLOR') {
          html += `<td>${cell !== null && cell !== undefined ? cell : ''}</td>`;
        }
      });
      html += '</tr>';
    }

    html += '</tbody></table>';
    document.getElementById('reportPreview').innerHTML = html;
  }

function generateCS24WithStatus(btn) {
  const originalText = btn.innerHTML;

  // üîí lock button + update text
  btn.disabled = true;
  btn.innerHTML = '‚è≥ Generating CS-24.........';

  try {
    const result = generateAllCS24MRUPDF();

    // ‚úÖ If your function already returns a Promise
    if (result && typeof result.then === 'function') {
      result
        .then(() => restore())
        .catch(() => restore());
    } else {
      // ‚ö†Ô∏è fallback (if function is not promise-based)
      setTimeout(restore, 4000);
    }

  } catch (e) {
    restore();
  }

  function restore() {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}




  function getReportTitle(reportType) {
    const titles = {
      'CA_21': 'CA-21: New Meter Installation Register',
      'CA_22': 'CA-22: Old Meter Removal Register',
      'CA_25': 'CA-25: Material Data Sheet',
      'CS_29': 'CS-29: Sealing Register'
    };
    
    // If it's a CA report, return the title
    if (titles[reportType]) {
      return titles[reportType];
    }
    
    // Otherwise, it's an MRU report
    return `MRU: ${reportType} - Connection/Disconnection Register`;
  }


  function openOfficeProfileForm() {
  
    loadOfficeProfile();
  }

  function closeOfficeProfile() {
    document.getElementById('officeProfileBox').classList.add('hidden');
  }

  /* Fetch existing profile (if any) */
  async function loadOfficeProfile() {
    const fd = new FormData();
    fd.append('action', 'getOfficeProfile');
    fd.append('username', currentUsername);

    const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    const data = JSON.parse(await res.text());

    if (data.status === 'success' && data.profile) {
      officeSection.value     = data.profile.section || '';
      officeStation.value    = data.profile.station || '';
      officeOfficer.value    = data.profile.officer || '';
      officeDesignation.value= data.profile.designation || 'Junior Engineer';
    }
  }

  /* Save or update profile */
  async function saveOfficeProfile() {

    if (!officeSection.value || !officeStation.value || !officeOfficer.value) {
      alert('Please fill all required fields');
      return;
    }

    const fd = new FormData();
    fd.append('action', 'saveOfficeProfile');
    fd.append('username', currentUsername);
    fd.append('section', officeSection.value.trim());
    fd.append('station', officeStation.value.trim());
    fd.append('officer', officeOfficer.value.trim());
    fd.append('designation', officeDesignation.value.trim());

    const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    const data = JSON.parse(await res.text());

    if (data.status === 'success') {
      alert('Office details saved successfully');
      closeOfficeProfile();
      applyOfficeProfileToPrint(data.profile);
    } else {
      alert(data.message || 'Save failed');
    }
  }

  function applyOfficeProfileToPrint(p) {

    document.getElementById('officeSectionPrint').textContent =
      p.section || '______________';

    document.getElementById('officeStationPrint').textContent =
      p.station || '______________';

    document.getElementById('officeOfficerPrint').textContent =
      p.officer || '____________';

    document.getElementById('officeDesignationPrint').textContent =
      p.designation || 'Junior Engineer';

    document.getElementById('officeSectionFooterPrint').textContent =
      p.section || '______________';
  }



  function exportToExcel() {
    const reportType = document.getElementById('reportType').value;
    if (!reportType) {
      alert('Please select a report type first');
      return;
    }

    const reportTitle = getReportTitle(reportType);
    const table = document.querySelector('#reportPreview table');
    if (!table) {
      alert('No data to export');
      return;
    }

    // Convert table to CSV with title
    let csv = [];
    
    // Add title as first row
    csv.push(`"${reportTitle}"`);
    csv.push(''); // Empty row for spacing
    
    const rows = table.querySelectorAll('tr');
    
    rows.forEach((row, rowIndex) => {
      const cols = row.querySelectorAll('td, th');
      const csvRow = [];
      
      // Get row color class if exists
      let rowColor = '';
      if (row.classList.contains('row-red')) rowColor = 'RED';
      if (row.classList.contains('row-green')) rowColor = 'GREEN';
      
      cols.forEach(col => {
        let data = col.innerText.replace(/"/g, '""'); // Escape quotes
        csvRow.push('"' + data + '"');
      });
      
      // Add color marker as comment for Excel
      if (rowColor && rowIndex > 0) {
        csvRow.push(`"[${rowColor}]"`);
      }
      
      csv.push(csvRow.join(','));
    });

    // Create blob and download
    const csvContent = '\uFEFF' + csv.join('\n'); // Add BOM for proper Excel encoding
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const fileName = `${reportType}_${currentUsername}_${new Date().toISOString().split('T')[0]}.csv`;
    
    link.setAttribute('href', url);
    link.setAttribute('download', fileName);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Show success message
    alert(`Report exported successfully!\nFile: ${fileName}\n\nNote: Red and Green colors are preserved in the CSV. Open with Excel for best viewing.`);
  }

  function preparePrintHeader() {
    const reportType = document.getElementById('reportType').value;
    const title = getReportTitle(reportType);

    // Set the main title
    document.getElementById('printReportTitle').textContent = title;
    
    // Set the username
    document.getElementById('printUsername').textContent = (currentUsername || 'System Admin').toUpperCase();
    
    // Set standard Indian format Date
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric'
    }) + ' ' + now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    
    document.getElementById('printDate').textContent = dateStr;
  }

  function printReport() {
    loadOfficeProfileForPrint(); // ensure latest data
    preparePrintHeader();
    window.print();
  }


  function closeCA25ReportsModal() {
    document.getElementById('ca25ReportsModal')
      .classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

  function openCA25ReportsFromDashboard() {
    // Close dashboard first
    closeReportsDashboard();

    // Open CA-25 Reports modal
    setTimeout(() => {
      loadCA25Reports();
    }, 150);
  }


  async function loadCA25Reports() {
    const modal = document.getElementById('ca25ReportsModal');
    const list = document.getElementById('ca25ReportList');

    if (!modal || !list) {
      console.error('CA-25 Reports modal not found');
      return;
    }

    // Open modal cleanly
    modal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    // Loading state
    list.innerHTML = '<li>Loading reports...</li>';

    try {
      const formData = new FormData();
      formData.append('action', 'listCA25PDFs');
      formData.append('username', currentUsername);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: formData
      });

      const result = JSON.parse(await res.text());

      if (result.status === 'success') {
        showCA25Reports('Available CA-25 Reports', result.reports);
      } else {
        list.innerHTML =
          `<li>${result.message || 'No CA-25 reports found'}</li>`;
      }
    } catch (err) {
      console.error('Error loading CA-25 reports', err);
      list.innerHTML = '<li>Error loading reports</li>';
    }
  }


  function formatDateTime(ts) {
    if (!ts) return 'Unknown';

    const d = new Date(Number(ts));
    if (isNaN(d.getTime())) return 'Unknown';

    return d.toLocaleString('en-IN', {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  }

  async function openSubmittedDataModal() {
    document.body.classList.add('modal-open');
    document.getElementById('submittedDataModal').classList.remove('hidden');

    const fd = new FormData();
    fd.append('action', 'fetchUserSheetData');
    fd.append('username', currentUsername);

    const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    const result = JSON.parse(await res.text());

    renderSubmittedDataTable(result.headers, result.rows);
  }

  function closeSubmittedDataModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('submittedDataModal').classList.add('hidden');
  }

  function applySubmittedFilter() {
    const text = document.getElementById('submittedSearch').value.toLowerCase();
    const orderType = document.getElementById('submittedOrderType').value;

    const filtered = submittedDataCache.filter(r => {
      const rowText = r.data.join(' ').toLowerCase();

      // Text search (Consumer ID / Name / Meter No)
      const textMatch = !text || rowText.includes(text);

      // Order Type match (Order Type column = index 9)
      const orderMatch = !orderType || r.data[9] === orderType;

      return textMatch && orderMatch;
    });

    renderSubmittedDataTable(
      Object.keys(submittedDataCache[0] || {}).length
        ? [] : [], // headers already handled
      filtered
    );
  }


  function renderSubmittedDataTable(headers, rows) {
  
  if (!submittedDataCache.length) {
    submittedDataCache = rows;
  }


    const table = document.getElementById('submittedDataTable');
    table.innerHTML = '';

    let html = '<thead><tr><th>üóë</th>';
    headers.forEach(h => html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';

    rows.forEach(r => {
      html += `<tr data-row="${r.rowIndex}">`;
      html += `<td><button onclick="deleteRow(${r.rowIndex})">üóë</button></td>`;

      r.data.forEach(cell => {
        html += `<td contenteditable="true">${cell ?? ''}</td>`;
      });

      html += '</tr>';
    });

    html += '</tbody>';
    table.innerHTML = html;
  }

  async function saveSubmittedData() {
    const updates = [];

    document.querySelectorAll('#submittedDataTable tbody tr').forEach(tr => {
      const rowIndex = Number(tr.dataset.row);
      const cells = [...tr.querySelectorAll('td')].slice(1);
      const data = cells.map(td => td.innerText.trim());

      updates.push({ rowIndex, data });
    });

    const fd = new FormData();
    fd.append('action', 'updateUserSheetData');
    fd.append('username', currentUsername);
    fd.append('updates', JSON.stringify(updates));

    const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      alert('‚úÖ Data saved successfully');
      closeSubmittedDataModal();
    } else {
      alert(result.message || 'Save failed');
    }
  }

  async function deleteRow(rowIndex) {
    if (!confirm('Delete this record permanently?')) return;

    const fd = new FormData();
    fd.append('action', 'deleteUserSheetRow');
    fd.append('username', currentUsername);
    fd.append('rowIndex', rowIndex);

    await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    openSubmittedDataModal(); // refresh
  }


function showToast(message, type = 'info', duration = 3000) {
  const toast = document.getElementById('toast');
  if (!toast) return;

  toast.className = `toast ${type}`;
  toast.innerHTML = message;
  toast.classList.remove('hidden');

  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => {
    toast.classList.add('hidden');
  }, duration);
}



  function showCA25Reports(message, reports) {
    const modal = document.getElementById('ca25ReportsModal');
    const list = document.getElementById('ca25ReportList');

    modal.classList.remove('hidden');
    document.body.classList.add('modal-open');
    list.innerHTML = '';

    if (!reports || reports.length === 0) {
      list.innerHTML = '<li>No CA-25 reports found</li>';
      return;
    }

    reports.forEach(rep => {
      const li = document.createElement('li');
      li.style.marginBottom = '16px';

      const generatedOn = rep.createdTime
        ? formatDateTime(rep.createdTime)
        : 'Unknown';

      li.innerHTML = `
        üìÑ <b>${rep.name}</b>
        <div style="font-size:12px;color:#666;margin:4px 0 6px">
          üïí Generated on: ${generatedOn}
        </div>
        <div>
          <button onclick="downloadCA25('${rep.url}')">üì• Download</button>
          <button onclick="renameCA25('${rep.id}','${rep.name}')">‚úèÔ∏è Rename</button>
          <button onclick="deleteCA25('${rep.id}')">üóë Delete</button>
        </div>
      `;
      list.appendChild(li);
    });
  }

  async function refreshCA25Reports() {
    const formData = new FormData();
    formData.append('action', 'listCA25PDFs');
    formData.append('username', currentUsername);

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      showCA25Reports('üìÇ Available CA-25 Reports', result.reports);
    }
  }

  function downloadCA25(url) {
    window.open(url, '_blank');
  }

  async function renameCA25(fileId, oldName) {
    const newName = prompt('Enter new file name', oldName);
    if (!newName || newName === oldName) return;

    const formData = new FormData();
    formData.append('action', 'renameCA25PDF');
    formData.append('fileId', fileId);
    formData.append('newName', newName);

    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });

    // ‚úÖ AUTO-REFRESH LIST (same as clicking ‚ÄúAvailable CA-25 Reports‚Äù)
    refreshCA25Reports();
  }

  async function deleteCA25(fileId) {
    if (!confirm('Are you sure you want to delete this PDF?')) return;

    const formData = new FormData();
    formData.append('action', 'deleteCA25PDF');
    formData.append('fileId', fileId);

    await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });

    // ‚úÖ AUTO-REFRESH LIST
    refreshCA25Reports();
  }



 async function generateAllCS24MRUPDF(btn) {
  let originalText = '';

  try {
    // üü° Button handling (safe even if btn not passed)
    if (btn) {
      originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Generating CS-24.........';
    }

    const formData = new FormData();
    formData.append('action', 'generateAllCS24MRUPDFs');
    formData.append('username', currentUsername);

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: formData
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      alert('‚úÖ CS-24 generated successfully!');
      loadCS24Reports(); // auto refresh list
    } else {
      alert(result.message || 'Failed to generate CS-24');
    }

  } catch (err) {
    console.error(err);
    alert('‚ùå CS-24 generation failed');

  } finally {
    // üîÅ Restore button state ALWAYS
    if (btn) {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }
}

  async function loadCS24Reports() {
    document.getElementById('cs24ReportsModal').classList.remove('hidden');
    document.getElementById('cs24ReportList').innerHTML = 'Loading...';

    try {
      const fd = new FormData();
      fd.append('action', 'listCS24PDFs');
      fd.append('username', currentUsername);

      const res = await fetch(SCRIPT_URL, { method: 'POST', body: fd });
      const result = JSON.parse(await res.text());

      if (result.status === 'success') {
        renderCS24Reports(result.reports);
      } else {
        document.getElementById('cs24ReportList').innerHTML =
          '<li>No CS-24 reports found</li>';
      }

    } catch (e) {
      console.error(e);
      document.getElementById('cs24ReportList').innerHTML =
        '<li>Error loading CS-24 reports</li>';
    }
  }

  function renderCS24Reports(reports) {
    const list = document.getElementById('cs24ReportList');
    list.innerHTML = '';

    if (!reports || reports.length === 0) {
      list.innerHTML = '<li>No CS-24 reports found</li>';
      return;
    }

    reports.forEach(rep => {
      const li = document.createElement('li');
      li.style.marginBottom = '14px';

      const date = new Date(rep.created).toLocaleString('en-IN');

      li.innerHTML = `
        üìÑ <b>${rep.name}</b>
        <div style="font-size:12px;color:#666;margin:4px 0">
          üïí ${date}
        </div>
        <div>
          <button onclick="window.open('${rep.url}','_blank')">üì• Open</button>
          <button onclick="renameCS24('${rep.id}','${rep.name}')">‚úèÔ∏è Rename</button>
          <button onclick="deleteCS24('${rep.id}')">üóë Delete</button>
        </div>
      `;

      list.appendChild(li);
    });
  }

  async function renameCS24(fileId, oldName) {
    const newName = prompt('Enter new file name', oldName);
    if (!newName || newName === oldName) return;

    const fd = new FormData();
    fd.append('action', 'renameCS24PDF');
    fd.append('fileId', fileId);
    fd.append('newName', newName);

    await fetch(SCRIPT_URL, { method: 'POST', body: fd });
    loadCS24Reports();
  }

  async function deleteCS24(fileId) {
    if (!confirm('Are you sure you want to delete this CS-24 PDF?')) return;

    try {
      const fd = new FormData();
      fd.append('action', 'deleteCS24PDF');
      fd.append('fileId', fileId);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: fd
      });

      const result = JSON.parse(await res.text());

      if (result.status === 'success') {
        loadCS24Reports(); // refresh list
      } else {
        alert(result.message || 'Delete failed');
      }

    } catch (e) {
      console.error(e);
      alert('Delete error');
    }
  }

  function closeCS24Modal() {
    document.getElementById('cs24ReportsModal').classList.add('hidden');
  }


async function generateRegisterPDF(registerType) {
  // ‚ùå DO NOT close Reports Dashboard here

  const fd = new FormData();
  fd.append('action', 'generateRegisterPDF');
  fd.append('username', currentUsername);
  fd.append('registerType', registerType);

  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: fd
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      showToast(`‚úÖ ${registerType} PDF generated successfully`, 'success');

      // ‚úÖ Keep dashboard open, just show reports
      openRegisterReports(registerType);
    } else {
      throw new Error(result.message || 'PDF generation failed');
    }

  } catch (e) {
    console.error(e);
    showToast('‚ùå Error generating PDF', 'error');
    throw e; // required for button status restore
  }
}



  function openRegisterReports(registerType) {
    closeReportsDashboard();

    setTimeout(() => {
      loadGenericRegisterReports(registerType);
    }, 150);
  }

  async function loadGenericRegisterReports(registerType) {

    const modal = document.getElementById('genericRegisterModal');
    const list = document.getElementById('genericRegisterList');
    const title = document.getElementById('genericRegisterTitle');
    const subtitle = document.getElementById('genericRegisterSubtitle');

    // üßπ Ensure modal is on top of everything
    document.querySelectorAll('.modal').forEach(m => {
      m.classList.add('hidden');
      m.style.zIndex = '';
    });

    modal.classList.remove('hidden');
    modal.style.zIndex = 1200; // higher than dashboard
    document.body.classList.add('modal-open');

    title.textContent = getReportTitle(registerType);
    subtitle.textContent = 'Generated PDFs stored in your cloud folder';

    list.innerHTML = `
      <li style="opacity:0.7;font-style:italic">
        Loading reports‚Ä¶
      </li>
    `;

    try {
      const fd = new FormData();
      fd.append('action', 'listGenericRegisterPDFs');
      fd.append('username', currentUsername);
      fd.append('registerType', registerType);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: fd
      });

      const text = await res.text();
      let result;

      try {
        result = JSON.parse(text);
      } catch {
        throw new Error('Invalid server response');
      }

      if (result.status === 'success' && Array.isArray(result.reports)) {

        if (result.reports.length === 0) {
          list.innerHTML = `
            <li style="opacity:0.7">
              No ${getReportTitle(registerType)} PDFs found
            </li>
          `;
          return;
        }

        renderGenericRegisterList(result.reports, registerType);

      } else {
        list.innerHTML = `
          <li style="color:#b91c1c">
            ${result.message || 'Unable to load reports'}
          </li>
        `;
      }

    } catch (err) {
      console.error('loadGenericRegisterReports error:', err);
      list.innerHTML = `
        <li style="color:#b91c1c">
          Error loading reports
        </li>
      `;
    }
  }

  function renderGenericRegisterList(reports, registerType) {
    const list = document.getElementById('genericRegisterList');
    list.innerHTML = '';

    reports.forEach(rep => {
      const li = document.createElement('li');
      li.style.marginBottom = '16px';

      const date = rep.createdTime
        ? formatDateTime(rep.createdTime)
        : 'Unknown';

      li.innerHTML = `
        üìÑ <b>${rep.name}</b>
        <div style="font-size:12px;color:#666;margin:4px 0 6px">
          üïí Generated on: ${date}
        </div>
        <div>
          <button onclick="window.open('${rep.url}','_blank')">üì• Open</button>
          <button onclick="renameGenericRegister('${rep.id}','${rep.name}','${registerType}')">‚úèÔ∏è Rename</button>
          <button onclick="deleteGenericRegister('${rep.id}','${registerType}')">üóë Delete</button>
        </div>
      `;

      list.appendChild(li);
    });
  }

  async function deleteGenericRegisterPDF(fileId, registerType) {

    if (!confirm('Are you sure you want to delete this PDF?')) return;

    const fd = new FormData();
    fd.append('action', 'deleteGenericRegisterPDF');
    fd.append('fileId', fileId);

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: fd
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      loadGenericRegisterReports(registerType);
    } else {
      alert(result.message || 'Delete failed');
    }
  }

  async function renameGenericRegisterPDF(fileId, registerType) {

    const newName = prompt('Enter new file name (without .pdf)');
    if (!newName) return;

    const fd = new FormData();
    fd.append('action', 'renameGenericRegisterPDF');
    fd.append('fileId', fileId);
    fd.append('newName', newName.endsWith('.pdf') ? newName : newName + '.pdf');

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: fd
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success') {
      loadGenericRegisterReports(registerType);
    } else {
      alert(result.message || 'Rename failed');
    }
  }
    



  function closeGenericRegisterModal() {
    document.getElementById('genericRegisterModal').classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

  async function renameGenericRegister(fileId, oldName, registerType) {
    const newName = prompt('Enter new file name', oldName);
    if (!newName || newName === oldName) return;

    const fd = new FormData();
    fd.append('action', 'renameGenericRegisterPDF');
    fd.append('fileId', fileId);
    fd.append('newName', newName);

    await fetch(SCRIPT_URL, { method: 'POST', body: fd });

    loadGenericRegisterReports(registerType);
  }

  async function deleteGenericRegister(fileId, registerType) {
    if (!confirm('Delete this PDF permanently?')) return;

    const fd = new FormData();
    fd.append('action', 'deleteGenericRegisterPDF');
    fd.append('fileId', fileId);

    await fetch(SCRIPT_URL, { method: 'POST', body: fd });

    loadGenericRegisterReports(registerType);
  }

function switchFilterMode() {
  const mode =
    document.querySelector('input[name="filterMode"]:checked')?.value || 'MONTH_YEAR';

  const monthBox = document.getElementById('monthYearFilter');
  const dateBox  = document.getElementById('dateRangeFilter');

  if (mode === 'DATE_RANGE') {
    monthBox.classList.add('hidden');
    dateBox.classList.remove('hidden');
  } else {
    dateBox.classList.add('hidden');
    monthBox.classList.remove('hidden');
    clearDateRange();
  }
}

function clearDateRange() {
  document.getElementById('fromDate').value = '';
  document.getElementById('toDate').value = '';
}

function resetDateFilters() {
  clearDateRange();
  loadReport();
}




  async function openInfoModal(key) {

    const modal = document.getElementById('infoModal');
    const titleEl = document.getElementById('infoTitle');
    const contentEl = document.getElementById('infoContent');

    titleEl.textContent = 'Loading...';
    contentEl.innerHTML = 'Please wait...';
    modal.classList.remove('hidden');

    try {
      const fd = new FormData();
      fd.append('action', 'fetchAppContent');
      fd.append('key', key);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: fd
      });

      const data = JSON.parse(await res.text());

      if (data.status === 'success') {
        titleEl.textContent = data.title;
        contentEl.innerHTML = formatContent(data.content);
      } else {
        titleEl.textContent = 'Error';
        contentEl.textContent = data.message;
      }

    } catch (err) {
      titleEl.textContent = 'Error';
      contentEl.textContent = 'Failed to load content';
    }
  }

  function formatContent(text) {
    if (!text) return '';
    return text
      .replace(/\n/g, '<br>')
      .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
  }

  function closeInfoModal() {
    document.getElementById('infoModal').classList.add('hidden');
  }


let ca25HistoryCache = [];

async function openCA25Modal() {
  if (document.getElementById('reportType').value !== 'CA_25') {
    showDashboardToast(
  '‚ö†Ô∏è PLEASE SELECT <b>CA-25</b> REPORT FIRST',
  'danger',
  4500
);

    return;
  }

  document.body.classList.add('modal-open');
  const modal = document.getElementById('ca25Modal');
  modal.classList.remove('hidden');

  try {
    const fd = new FormData();
    fd.append('action', 'getAllCA25Details');
    fd.append('username', currentUsername);

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: fd
    });

    const result = JSON.parse(await res.text());
    if (result.status !== 'success') {
      throw new Error('Failed to load CA-25 history');
    }

    ca25HistoryCache = result.data || [];

    const select = document.getElementById('ca25HistorySelect');
    select.innerHTML = '<option value="">‚Äî Select saved work ‚Äî</option>';

    // Populate dropdown (latest first)
    ca25HistoryCache.forEach((row, index) => {
      const opt = document.createElement('option');
      opt.value = index;
      opt.textContent = row.workName || '(Unnamed Work)';
      select.appendChild(opt);
    });

    // ‚úÖ Auto-select latest entry
    if (ca25HistoryCache.length > 0) {
      select.value = 0;
      applyCA25History(0);
    }

  } catch (e) {
    console.error('CA-25 dynamic load failed', e);
    showDashboardToast('‚ö†Ô∏è Could not load saved CA-25 entries', 'error');
  }
}

function applyCA25History(index) {
  if (index === '' || !ca25HistoryCache[index]) return;

  const data = ca25HistoryCache[index];

  document.getElementById('ca25WorkName').value =
    data.workName || '';

  document.getElementById('ca25MeasurementBy').value =
    data.measurementBy || '';

  document.getElementById('ca25OfficerName').value =
    data.officerName || '';

  document.getElementById('ca25OfficerDesignation').value =
    data.officerDesignation || '';
}



function closeCA25Modal() {
  // ‚úÖ Close ONLY the CA-25 modal
  const modal = document.getElementById('ca25Modal');
  if (modal) {
    modal.classList.add('hidden');
  }

  // ‚ùå DO NOT touch document.body.classList here
  // Reports Dashboard must remain open
}


 function submitCA25Modal() {

  const btn = document.getElementById('submitCA25Btn');
  const originalText = btn ? btn.innerText : '';

  if (btn) {
    btn.disabled = true;
    btn.innerText = '‚è≥ Generating CA-25...';
  }

  const fd = new FormData();
  fd.append('action', 'generateCA25PDF');
  fd.append('username', currentUsername);
  fd.append('workName', document.getElementById('ca25WorkName').value);
  fd.append('measurementBy', document.getElementById('ca25MeasurementBy').value);
  fd.append('officerName', document.getElementById('ca25OfficerName').value);
  fd.append('officerDesignation', document.getElementById('ca25OfficerDesignation').value);

  fetch(SCRIPT_URL, {
    method: 'POST',
    body: fd
  })
  .then(res => res.text())
  .then(text => {
    let res;
    try {
      res = JSON.parse(text);
    } catch {
      throw new Error('Invalid server response');
    }

    if (btn) {
      btn.disabled = false;
      btn.innerText = originalText;
    }

    if (res.status === 'success') {

      // ‚úÖ Close ONLY CA-25 modal
      closeCA25Modal();

      // ‚úÖ Show toast INSIDE dashboard
      showDashboardToast('‚úÖ CA-25 PDF generated successfully', 'success');

      // ‚úÖ Refresh dropdown/history if needed
      if (typeof refreshCA25HistoryDropdown === 'function') {
        refreshCA25HistoryDropdown(true);
      }

    } else {
      showDashboardToast(res.message || '‚ùå Failed to generate CA-25', 'error');
    }
  })
  .catch(err => {
    console.error('CA-25 generation error:', err);

    if (btn) {
      btn.disabled = false;
      btn.innerText = originalText;
    }

    showDashboardToast(
      '‚ùå Error generating CA-25 PDF',
      'error'
    );
  });
}


  function openOfficeProfileModal() {
    document.getElementById('officeProfileModal')
      .classList.remove('hidden');
    document.body.classList.add('modal-open');

    // Load saved office data (existing function)
    openOfficeProfileForm(); 
  }

  function closeOfficeProfileModal() {
    document.getElementById('officeProfileModal')
      .classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

  function openCS24FromDashboard() {
    // Close dashboard first
    closeReportsDashboard();

    // Small delay for clean transition
    setTimeout(() => {
      loadCS24Reports(); // existing function (opens CS-24 modal)
    }, 150);
  }
  function openCA25FromDashboard() {
    // 1Ô∏è‚É£ Close Reports Dashboard modal
    const dashboard = document.getElementById('reportsDashboardModal');
    if (dashboard) {
      dashboard.classList.add('hidden');
    }

    // 2Ô∏è‚É£ Remove modal-open class temporarily
    document.body.classList.remove('modal-open');

    // 3Ô∏è‚É£ Open CA-25 modal after smooth transition
    setTimeout(() => {
      loadCA25Reports(); // existing function that opens CA-25 modal
    }, 150);
  }

function openCA25GenerateFromDashboard() {
  // ‚úÖ Keep Reports Dashboard OPEN
  // ‚úÖ Keep modal-open intact

  // Simply open CA-25 modal on top of dashboard
  openCA25Modal();
}



async function deleteSelectedCA25Entry() {
  setTimeout(async () => {

    const select = document.getElementById('ca25HistorySelect');
    const index = select.value;

    if (index === '' || !ca25HistoryCache[index]) {
      showDashboardToast('‚ÑπÔ∏è Please select an entry to delete', 'info');
      return;
    }

    const entry = ca25HistoryCache[index];

    if (!confirm(`Delete entry:\n"${entry.workName || 'Unnamed Work'}"?`)) {
      return;
    }

    try {
      const fd = new FormData();
      fd.append('action', 'deleteCA25Detail');
      fd.append('username', currentUsername);
      fd.append('workName', entry.workName);

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: fd
      });

      const result = JSON.parse(await res.text());

      if (result.status === 'success') {
        showDashboardToast('üóë Entry deleted successfully', 'success');

        // üîÑ Refresh dropdown safely
        openCA25Modal();
      } else {
        throw new Error(result.message || 'Delete failed');
      }

    } catch (e) {
      console.error(e);
      showDashboardToast('‚ùå Failed to delete entry', 'error');
    }

  }, 0); // üëà yields UI thread first
}

window.showDashboardToast ||= function (msg) {
  console.log('[Toast fallback]', msg);
};

function showDashboardToast(message, type = 'info', duration = 3500) {
  const toast = document.getElementById('dashboardToast');

  if (!toast) {
    console.warn('Dashboard toast element not found:', message);
    return;
  }

  // üî• Force visibility (bypasses CSS conflicts)
  toast.classList.remove('hidden');
  toast.className = `dashboard-toast ${type}`;
  toast.innerHTML = message;


  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => {
    toast.classList.add('hidden');
  }, duration);
}

async function loadAppUpdateBanner() {
  try {
    const fd = new FormData();
    fd.append('action', 'fetchAppContent');
    fd.append('key', 'app_update'); // üëà using your handler

    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      body: fd
    });

    const result = JSON.parse(await res.text());

    if (result.status === 'success' && result.content) {
      const banner = document.getElementById('appUpdateBanner');
      banner.innerHTML = `üì¢ ${result.content}`;
      banner.classList.remove('hidden');
    }
  } catch (e) {
    console.warn('App update not available');
  }
}




  function openReportsDashboard() {
    document.getElementById('reportsDashboardModal')
      .classList.remove('hidden');
    document.body.classList.add('modal-open');
  }

  function closeReportsDashboard() {
    document.getElementById('reportsDashboardModal')
      .classList.add('hidden');
    document.body.classList.remove('modal-open');
  }

async function generateRegisterPDFWithStatus(btn, label, registerType) {
  const originalText = btn.innerHTML;

  try {
    // üîí Lock button + status text
    btn.disabled = true;
    btn.innerHTML = `‚è≥ Generating ${label}.........`;

    // ‚ñ∂ Call your existing function
    await generateRegisterPDF(registerType);

  } catch (err) {
    console.error(err);
    alert(`‚ùå ${label} generation failed`);

  } finally {
    // üîÅ Always restore
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

function openUserManualModal() {
  document.getElementById('userManualModal').classList.remove('hidden');
  document.body.classList.add('modal-open');
}

function closeUserManualModal() {
  document.getElementById('userManualModal').classList.add('hidden');
  document.body.classList.remove('modal-open');
}



  /* ---------- HELPERS ---------- */
  function showLogin(msg, type) {
    loginMessage.textContent = msg;
    loginMessage.className = 'message ' + type;
    loginMessage.style.display = msg ? 'block' : 'none';
  }

  function showForm(msg, type) {
    responseMessage.textContent = msg;
    responseMessage.className = 'message ' + type;
    responseMessage.style.display = msg ? 'block' : 'none';
  }

  function logout() {
    localStorage.removeItem('username');
    location.reload();
  }


/* =========================================================
   APP BOOTSTRAP (SINGLE ENTRY POINT ‚Äì DO NOT DUPLICATE)
   ========================================================= */
window.addEventListener('DOMContentLoaded', () => {

  /* üîê DEVICE ID */
  deviceId = generateDeviceId();

  /* üîÅ RESTORE USER SESSION */
  const saved = localStorage.getItem('username');
  if (saved) {
    currentUsername = saved;
    loginContainer.classList.add('hidden');
    mainContainer.classList.remove('hidden');
    currentUser.textContent = currentUsername;
  }

  /* üì¢ LOAD APP UPDATE BANNER */
  if (typeof loadAppUpdateBanner === 'function') {
    loadAppUpdateBanner();
  }

  /* ü¶∂ FOOTER AUTO-UPDATE (SAFE & GUARANTEED) */
  const footerEl = document.getElementById('appFooterText');
  if (footerEl) {
    const startYear = 2025;
    const currentYear = new Date().getFullYear();
    const yearText =
      currentYear > startYear ? `${startYear}‚Äì${currentYear}` : `${startYear}`;

    const version = 'v2.3';

    footerEl.innerHTML = `
      Designed & Developed by <b>Er. Ajay Kumar</b> ¬© ${yearText} |
      Version <b>${version}</b> |
      üìû <b>+91-7018756182</b> |
      ‚úâÔ∏è <b>ErAjay.HPSEB@gmail.com</b>
    `;
  }
});

(function initMonthYear() {
  const now = new Date();
  const m = document.getElementById('reportMonth');
  const y = document.getElementById('reportYear');
  if (!m || !y) return;
  m.value = now.getMonth();
  y.value = now.getFullYear();
})();


</script>

<footer class="app-footer" style="text-align:center;color:#fff;margin-top:30px">
  <span id="appFooterText"></span>

  <div class="footer-links">
    <a onclick="openInfoModal('about')">About</a> |
    <a onclick="openInfoModal('policy')">Privacy Policy</a> |
    <a onclick="openInfoModal('terms')">Terms</a> |
    <a onclick="openInfoModal('disclaimer')">Disclaimer</a> |
    <a onclick="openInfoModal('help')">Help</a> |
    <a onclick="openInfoModal('changelog')">Changelog</a>
  </div>
</footer>

<!-- ================= INFO MODAL ================= -->
<div id="infoModal" class="info-modal hidden">
  <div class="info-card">
    <div class="info-header">
      <h2 id="infoTitle"></h2>
      <button onclick="closeInfoModal()">‚úñ</button>
    </div>
    <div id="infoContent" class="info-content"></div>
  </div>
</div>





  </body>
  </html>
